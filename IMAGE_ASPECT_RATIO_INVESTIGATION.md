# Image Aspect Ratio Investigation Report

## Issue Summary

**Problem:** Portrait images (e.g., 1080x1346 pixels, aspect ratio ~0.80) in the Custom Props project gallery are being displayed at an incorrect aspect ratio:
- **Expected:** 1080 x 1346 px (portrait, aspect ratio ~0.80)
- **Actual Intrinsic Size:** 800 x 600 px (4:3 aspect ratio)
- **Evidence:** Sanity URL shows `h=3D600` parameter being added somehow

Despite multiple attempts to fix the issue, including:
1. Removing aspectRatio parameter from urlForWithOptions
2. Using basic urlFor() with only width, quality, and auto('format')
3. Changing container from fixed aspect-[16/9] to dynamic style={{ aspectRatio }}
4. Changing from object-cover to object-contain

The image continues to be cropped to 4:3 aspect ratio.

---

## Root Causes Analysis

### 1. **Next.js Image Component with fill + sizes (HIGH PROBABILITY)**

**Explanation:**
When using `fill` with the Next.js Image component, Next.js generates a responsive `srcset` with multiple image sizes based on the `sizes` prop. The `sizes` prop in ProjectSlideshow.tsx is:
- Main images: `sizes="(max-width: 768px) 100vw, 1400px"`
- Thumbnails: `sizes="200px"`

Next.js automatically generates image variants at specific widths defined in `next.config.ts` through:
- `deviceSizes`: [640, 750, 828, 1080, 1200, 1920, 2048, 3840] (default if not overridden)
- `imageSizes`: [16, 32, 48, 64, 96, 128, 256, 384] (default if not overridden)

**Evidence:**
- `/Users/michaelevans/DOA/doa-website/src/components/ProjectSlideshow.tsx:123` - `fill` with `sizes="(max-width: 768px) 100vw, 1400px"`
- `/Users/michaelevans/DOA/doa-website/src/components/ProjectSlideshow.tsx:151` - `fill` with `sizes="(max-width: 768px) 100vw, 1400px"`
- `/Users/michaelevans/DOA/doa-website/next.config.ts:4-12` - No custom deviceSizes or imageSizes configured
- Next.js documentation confirms: "With sizes specified, Next.js generates a full srcset (e.g. 640w, 750w, etc.)"

**Why this causes the issue:**
Next.js may be passing the src URL (generated by urlFor()) through its built-in image optimization pipeline, which could be:
1. Proxying through `/_next/image?url=...&w=800&q=75`
2. Adding width/height parameters to maintain aspect ratio for optimization
3. Defaulting to a 4:3 aspect ratio when only width is provided

**Recommended Fix:**
```typescript
// Option A: Disable Next.js optimization for Sanity images
<Image
  src={getMainImageUrl(images[currentIndex], 1600)}
  unoptimized={true}  // Bypass Next.js optimization
  fill
  className="object-contain"
  sizes="(max-width: 768px) 100vw, 1400px"
/>

// Option B: Remove fill and use explicit dimensions
const { width, height } = images[currentIndex].asset?.metadata?.dimensions || {}
<Image
  src={getMainImageUrl(images[currentIndex], 1600)}
  width={width}
  height={height}
  className="object-contain w-full h-full"
  sizes="(max-width: 768px) 100vw, 1400px"
/>

// Option C: Use a custom loader to bypass optimization
<Image
  src={getMainImageUrl(images[currentIndex], 1600)}
  fill
  loader={({ src }) => src}  // Return src as-is
  className="object-contain"
  sizes="(max-width: 768px) 100vw, 1400px"
/>
```

---

### 2. **Sanity CDN URL Encoding Issue (MEDIUM PROBABILITY)**

**Explanation:**
The observed URL shows `h=3D600` instead of `h=600`. The `3D` is the URL-encoded representation of `=`, suggesting double-encoding:
- `=` gets encoded to `%3D`
- Then displayed or re-encoded as `3D`

This could mean:
1. The URL builder is encoding the `=` sign
2. Something is double-encoding the URL
3. The browser DevTools is showing the encoded version

**Evidence:**
- User reported seeing `h=3D600` in the Sanity URL
- `/Users/michaelevans/DOA/doa-website/sanity/lib/image.ts:44-46` - urlFor() returns a builder instance
- The builder's `.url()` method should return a properly formatted string

**Why this causes the issue:**
If the URL is malformed due to encoding issues, Sanity CDN might:
1. Ignore the malformed parameters
2. Fall back to default dimensions
3. Apply incorrect transformations

**Recommended Fix:**
```typescript
// Ensure URL is properly decoded and not double-encoded
const getMainImageUrl = (image: SanityResponsiveImage, width = 1600) => {
  if (!image) return '/placeholder.jpg'
  try {
    const url = urlFor(image)
      .width(width)
      .quality(85)
      .auto('format')
      .url()
    
    // Decode any double-encoded parameters
    const decodedUrl = decodeURIComponent(url)
    console.log('Generated URL:', decodedUrl)
    return decodedUrl
  } catch {
    return '/placeholder.jpg'
  }
}
```

---

### 3. **Browser Caching Old Cropped Images (MEDIUM PROBABILITY)**

**Explanation:**
If previous versions of the code used `urlForWithOptions` with aspect ratio cropping, the browser or CDN might have cached those cropped versions. Even though the code now generates URLs without aspect ratio parameters, the browser might be serving cached 4:3 versions.

**Evidence:**
- `/Users/michaelevans/DOA/doa-website/sanity/lib/image.ts:74-115` - urlForWithOptions includes aspect ratio logic with fit('crop')
- User mentioned "multiple attempts to fix it" suggesting code has been changed
- Sanity CDN uses aggressive caching (seen in headers: `cache-control: private,no-store`, `x-varnish-age: 0`)

**Why this causes the issue:**
- Browser cache (disk or memory cache) serving old 800x600 image
- CDN edge cache has old version
- Service worker intercepting requests (unlikely but possible)

**Recommended Fix:**
```bash
# Clear browser cache completely
# Chrome DevTools: Network tab â†’ Disable cache checkbox
# Or hard refresh: Cmd+Shift+R (Mac) or Ctrl+Shift+R (Windows)

# Add cache busting parameter to URL
const getMainImageUrl = (image: SanityResponsiveImage, width = 1600) => {
  if (!image) return '/placeholder.jpg'
  try {
    const url = urlFor(image)
      .width(width)
      .quality(85)
      .auto('format')
      .url()
    
    // Add timestamp to bust cache
    const cacheBuster = `${url}${url.includes('?') ? '&' : '?'}v=${Date.now()}`
    return cacheBuster
  } catch {
    return '/placeholder.jpg'
  }
}
```

---

### 4. **Missing or Incorrect Metadata from Sanity Query (LOW PROBABILITY)**

**Explanation:**
The `aspectRatio` used to set the container dimensions comes from `images[currentIndex]?.asset?.metadata?.dimensions?.aspectRatio`. If this metadata is:
- Missing (undefined)
- Incorrect (defaulting to 16/9)
- Not being queried properly

Then the container would be sized incorrectly.

**Evidence:**
- `/Users/michaelevans/DOA/doa-website/sanity/lib/queries.ts:24-34` - Gallery query includes metadata.dimensions
- `/Users/michaelevans/DOA/doa-website/src/components/ProjectSlideshow.tsx:132` - Fallback to 16/9 if undefined
- `/Users/michaelevans/DOA/doa-website/src/types/sanity.ts:41-59` - Metadata interface looks complete

**Why this causes the issue:**
If metadata is missing:
1. Container defaults to 16:9 aspect ratio
2. Image is forced into wrong container shape
3. Object-contain would show letterboxing but correct proportions
4. This doesn't explain the 4:3 cropping, so this is unlikely the main issue

**Recommended Fix:**
```typescript
// Add defensive logging and validation
const currentAspectRatio = (() => {
  const metadata = images[currentIndex]?.asset?.metadata?.dimensions
  console.log('Image metadata:', metadata)
  
  if (!metadata?.aspectRatio) {
    console.warn('Missing aspectRatio, using dimensions to calculate')
    if (metadata?.width && metadata?.height) {
      return metadata.width / metadata.height
    }
    console.warn('No dimensions available, falling back to 16:9')
    return 16 / 9
  }
  
  return metadata.aspectRatio
})()
```

---

### 5. **Sanity Image URL Builder fit() or crop() Being Applied (LOW PROBABILITY)**

**Explanation:**
The `urlForWithOptions` function in `/Users/michaelevans/DOA/doa-website/sanity/lib/image.ts` has logic that applies `.fit('crop').crop('focalpoint')` when aspect ratio is specified. Even though ProjectSlideshow uses basic `urlFor()`, if hotspot or crop metadata exists on the image asset in Sanity, it might be automatically applied.

**Evidence:**
- `/Users/michaelevans/DOA/doa-website/sanity/lib/image.ts:91-102` - Aspect ratio logic with fit/crop
- `/Users/michaelevans/DOA/doa-website/sanity/lib/queries.ts:32` - Hotspot is queried
- Sanity documentation confirms: "hotspot and crop processing is only applied when both width and height specified"

**Why this causes the issue:**
If the basic `urlFor()` is somehow triggering crop behavior:
1. Image has hotspot/crop metadata saved in Sanity
2. Sanity CDN applies it automatically even without fit() parameters
3. Results in 4:3 crop

**Note:** This is low probability because:
- Sanity only applies crop when BOTH width AND height are provided
- Current code only provides width
- Basic urlFor() shouldn't add height

**Recommended Fix:**
```typescript
// Explicitly disable hotspot/crop
const getMainImageUrl = (image: SanityResponsiveImage, width = 1600) => {
  if (!image) return '/placeholder.jpg'
  try {
    const url = urlFor(image)
      .width(width)
      .quality(85)
      .auto('format')
      .fit('max')  // Explicitly set fit mode to prevent cropping
      .url()
    return url
  } catch {
    return '/placeholder.jpg'
  }
}
```

---

### 6. **Global CSS Affecting Image Aspect Ratios (VERY LOW PROBABILITY)**

**Explanation:**
Global CSS rules could potentially override aspect ratios or object-fit properties.

**Evidence:**
- `/Users/michaelevans/DOA/doa-website/src/app/globals.css` - No global img rules affecting aspect ratio
- No global styles found that would force 4:3 aspect ratio
- Tailwind CSS doesn't include default aspect ratio overrides

**Why this is unlikely:**
- No global img { } rules found
- object-contain is explicitly set on Image components
- No evidence of CSS forcing dimensions

**Recommended Fix:**
Not applicable - no CSS issues found.

---

## Recommended Approach

### Phase 1: Quick Diagnostics (5 minutes)

1. **Clear all caches:**
   ```bash
   # In browser DevTools
   - Open Network tab
   - Check "Disable cache"
   - Hard refresh: Cmd+Shift+R
   
   # Clear Next.js build cache
   rm -rf .next
   npm run dev
   ```

2. **Inspect the actual URL:**
   ```javascript
   // In ProjectSlideshow.tsx, line 30
   console.log('Main image URL:', url, 'Metadata:', image.asset?.metadata?.dimensions)
   ```
   
   Then check:
   - Does the URL contain `h=` or `height=` parameters?
   - Is the URL properly formatted (no `3D` encoding issues)?
   - What are the actual metadata dimensions?

3. **Check browser Network tab:**
   - Look at the actual HTTP request for the image
   - Check if it's going through `/_next/image?url=...`
   - Or directly to `cdn.sanity.io`

### Phase 2: Implement Most Likely Fix (10 minutes)

**Based on highest probability (Next.js optimization), try Option C first:**

```typescript
// In ProjectSlideshow.tsx
<Image
  src={getMainImageUrl(images[currentIndex], 1600)}
  fill
  loader={({ src }) => src}  // Bypass Next.js optimization
  className="object-contain"
  sizes="(max-width: 768px) 100vw, 1400px"
  priority={currentIndex === 0}
/>
```

This will:
- Bypass Next.js image optimization entirely
- Use the Sanity CDN URL directly
- Preserve original aspect ratios
- Still work with fill and object-contain

### Phase 3: Alternative Solutions (if Phase 2 doesn't work)

**Option A: Use unoptimized prop**
```typescript
<Image
  src={getMainImageUrl(images[currentIndex], 1600)}
  fill
  unoptimized={true}
  className="object-contain"
  sizes="(max-width: 768px) 100vw, 1400px"
/>
```

**Option B: Use explicit dimensions instead of fill**
```typescript
const currentImage = images[currentIndex]
const { width, height } = currentImage.asset?.metadata?.dimensions || { width: 1080, height: 1346 }

<div className="relative" style={{ aspectRatio: width / height }}>
  <Image
    src={getMainImageUrl(currentImage, 1600)}
    width={width}
    height={height}
    className="object-contain w-full h-full"
    sizes="(max-width: 768px) 100vw, 1400px"
  />
</div>
```

**Option C: Add fit('max') to Sanity URL builder**
```typescript
const getMainImageUrl = (image: SanityResponsiveImage, width = 1600) => {
  if (!image) return '/placeholder.jpg'
  try {
    const url = urlFor(image)
      .width(width)
      .quality(85)
      .fit('max')  // Prevent upscaling and cropping
      .auto('format')
      .url()
    console.log('Main image URL:', url)
    return url
  } catch {
    return '/placeholder.jpg'
  }
}
```

---

## Additional Diagnostic Steps

### Check if Next.js is proxying the images:

1. Open browser DevTools â†’ Network tab
2. Load the projects page with the portrait image
3. Find the image request
4. Check if the URL is:
   - `/_next/image?url=https://cdn.sanity.io/...` (Next.js is optimizing)
   - `https://cdn.sanity.io/images/...` (Direct from Sanity)

### Verify Sanity metadata:

```typescript
// Add this temporarily to ProjectSlideshow.tsx
useEffect(() => {
  images.forEach((img, idx) => {
    console.log(`Image ${idx}:`, {
      dimensions: img.asset?.metadata?.dimensions,
      hasHotspot: !!img.hotspot,
      hasCrop: !!img.crop,
      url: getMainImageUrl(img, 1600)
    })
  })
}, [images])
```

### Test with different widths:

```typescript
// Try different widths to see if height is being auto-calculated
getMainImageUrl(image, 1080)  // Original width
getMainImageUrl(image, 800)   // Current problematic width
getMainImageUrl(image, 640)   // Smaller width
```

---

## Files Analyzed

1. `/Users/michaelevans/DOA/doa-website/src/components/ProjectSlideshow.tsx` - Main component
2. `/Users/michaelevans/DOA/doa-website/sanity/lib/image.ts` - URL builder functions
3. `/Users/michaelevans/DOA/doa-website/sanity/lib/queries.ts` - Sanity queries
4. `/Users/michaelevans/DOA/doa-website/next.config.ts` - Next.js configuration
5. `/Users/michaelevans/DOA/doa-website/src/types/sanity.ts` - Type definitions
6. `/Users/michaelevans/DOA/doa-website/src/app/globals.css` - Global styles
7. `/Users/michaelevans/DOA/doa-website/sanity/lib/client.ts` - Sanity client config

---

## Technical Dependencies

- **@sanity/image-url**: v1.2.0
- **next**: v15.5.4
- **react**: v19.0.0

---

## Conclusion

The most likely cause is **Next.js Image optimization** adding height parameters or proxying images through its optimization pipeline, which defaults to common aspect ratios (like 4:3) when only width is provided. The quick fix is to add a custom `loader` prop or use `unoptimized={true}` to bypass Next.js optimization and use Sanity CDN directly.

The second most likely cause is **browser/CDN caching** serving old cropped versions from when the code used aspect ratio parameters.

The encoding issue (`h=3D600`) needs further investigation to determine if it's a display artifact or actual URL malformation.
